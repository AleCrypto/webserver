define(["lib/react","lib/clib","stores/EngineVirtualStore","actions/ChatActions"],function(e,t,n,r){function o(e,t){var n=this,r="msg-chat-message";switch(e.type){case"say":e.role==="admin"&&(r+=" msg-admin-message");var s=n.state.engine.username;return s&&e.username!=s&&e.message.toLowerCase().indexOf(s.toLowerCase())!=-1&&(r+=" msg-highlight-message"),i.li({className:r,key:"msg"+t},i.a({href:"/user/"+e.username,target:"_blank"},e.username,":")," ",e.message);case"mute":return r="msg-mute-message",i.li({className:r,key:"msg"+t},i.a({href:"/user/"+e.moderator,target:"_blank"},"*** <"+e.moderator+">"),e.shadow?" shadow muted ":" muted ",i.a({href:"/user/"+e.username,target:"_blank"},"<"+e.username+">")," for "+e.timespec);case"error":case"info":return r="msg-info-message",i.li({className:r,key:"msg"+t},i.span(null," *** "+e.message));default:}}function u(){return{engine:n.getState()}}var i=e.DOM,s=120;return e.createClass({displayName:"Chat",getInitialState:function(){var e=u();return this.listLength=e.engine.chat.length,e},componentDidMount:function(){n.addChangeListener(this._onChange);var e=this.refs.messages.getDOMNode();e.scrollTop=e.scrollHeight},componentWillUnmount:function(){n.removeChangeListener(this._onChange)},shouldComponentUpdate:function(e,t){return t.engine.chat.length!=this.listLength?(this.listLength=t.engine.chat.length,!0):!1},componentDidUpdate:function(){var e=this.refs.messages.getDOMNode(),t=e.scrollHeight-e.offsetHeight-e.scrollTop;t<s&&(e.scrollTop=e.scrollHeight)},_onChange:function(){this.setState(u())},_sendMessage:function(e){if(e.keyCode==13){var t=this.refs.input.getDOMNode().value;t.length>1&&t.length<500&&(this._say(t),this.refs.input.getDOMNode().value="")}},_say:function(e){r.say(e)},render:function(){var e=this,t=this.state.engine.chat.map(o,e),n;return this.state.engine.username?n=i.input({className:"chat-input",onKeyDown:this._sendMessage,ref:"input",placeholder:"Type here..."}):n=i.input({className:"chat-input",onKeyDown:this._sendMessage,ref:"input",placeholder:"Log in to chat...",disabled:!0}),i.div({className:"messages-container"},i.ul({className:"messages",ref:"messages"},t),n)}})});