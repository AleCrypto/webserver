define(["lib/react","lib/clib","lib/lodash","components2/payout","components2/countdown"],function(e,t,n,r,i){function o(e){return e<=100?"bit":"bits"}var s=e.DOM;return e.createClass({displayName:"Controls",propTypes:{engine:e.PropTypes.object.isRequired},componentWillMount:function(){var e=this;e.props.engine.on("cancel_bet",function(){e.setState({auto_play:!1})})},getInitialState:function(){return{bet_size:"1",cash_out:"2.00",auto_play:!1}},invalidBet:function(){var e=this;if(e.props.engine.balanceSatoshis<100)return"Not enough bits to play";if(!/^\d+k*$/.test(e.state.bet_size))return"Bet may only contain digits, and k (to mean 1000)";var t=parseInt(e.state.bet_size.replace(/k/g,"000"));if(t<1)return"The bet should be at least 1 bit";if(t>1e6)return"The bet must be less no more than 1,000,000 bits";var r=e.state.cash_out;return/^\d+(\.\d{1,2})?$/.test(r)?(r=parseFloat(r),console.assert(!n.isNaN(r)),n.isNaN(t)||r<1||Math.floor(t)!==t?"The bet should be an integer greater than or equal to one":e.props.engine.balanceSatoshis<t*100?"Not enough bits":null):"Invalid auto cash out amount"},placeBet:function(){var e=parseInt(this.state.bet_size.replace(/k/g,"000"))*100;console.assert(n.isFinite(e));var t=parseFloat(this.state.cash_out);console.assert(n.isFinite(t)),t=Math.round(t*100),console.assert(n.isFinite(t)),this.props.engine.bet(e,t,this.state.auto_play,function(e){e&&console.error("Got betting error: ",e)})},cashOut:function(){this.props.engine.cashOut(function(e){e&&console.warn("Got cash out error: ",e)})},cancelPlaceBet:function(){throw new Error("todo cancel place bet!")},getStatusMessage:function(){if(this.props.engine.gameState==="STARTING")return console.log("showing starting..."),i({engine:this.props.engine});if(this.props.engine.gameState==="IN_PROGRESS")return this.props.engine.userState==="PLAYING"?s.span(null,"Currently playing..."):this.props.engine.lastGameWonAmount?s.span(null,"Cashed Out @  ",s.b({className:"green"},this.props.engine.lastGameWonAmount/this.props.engine.lastBet,"x")," / Won: ",s.b({className:"green"},t.formatSatoshis(this.props.engine.lastGameWonAmount))," ",o(this.props.engine.lastGameWonAmount)):s.span(null,"Game in progress..");if(this.props.engine.gameState==="ENDED"){console.log("sm: ended");if(this.props.engine.lastBet&&this.props.engine.lastGameWonAmount){console.log("sm: bet and won");var e;return this.props.engine.lastBonus&&(e=s.span(null,s.br()," (+",t.formatSatoshis(this.props.engine.lastBonus)," ",o(this.props.engine.lastBonus)," bonus)")),s.span(null,"Cashed Out @ ",s.b({className:"green"},this.props.engine.lastGameWonAmount/this.props.engine.lastBet,"x")," / Won: ",s.b({className:"green"},t.formatSatoshis(this.props.engine.lastGameWonAmount))," ",o(this.props.engine.lastGameWonAmount),e)}if(this.props.engine.lastBet){console.log("sm: bet and lost");var e;return this.props.engine.lastBonus&&(e=s.span(null,s.br(),"..but got a ",t.formatSatoshis(this.props.engine.lastBonus)," ",o(this.props.engine.lastBonus)," bonus")),s.span(null,"Game crashed @ ",s.b({className:"red"},this.props.engine.lastGameCrashedAt/100,"x")," / You lost ",s.b({className:"red"},this.props.engine.lastBet/100)," ",o(this.props.engine.lastBet),e)}return s.span(null,"Game crashed @ ",s.b({className:"red"},this.props.engine.lastGameCrashedAt/100,"x"))}},getBetter:function(){var e=this,t=e.invalidBet(),n;t?n=s.a({className:"big-button-disable unclick unselect"},"Place Bet!"):n=s.a({className:"big-button unselect",onClick:e.placeBet},"Place Bet!");var r=s.div(null,s.div({className:"auto-cash-out-span"},"Auto Cash Out @ "),s.input({min:1.1,value:e.state.cash_out,type:"number",name:"cash_out",onChange:function(t){e.setState({cash_out:t.target.value})}}),s.span({className:"sticky"},"x"));return s.div(null,s.div({className:"col-6-12"},s.div({className:"left-side unselect"},s.span({className:"bet-span strong"},"Bet"),s.input({type:"text",name:"bet-size",value:e.state.bet_size,onChange:function(t){e.setState({bet_size:t.target.value})}}),s.span({className:"sticky"},"Bits"))),s.div({className:"col-6-12 place-bet"},n,t?s.div({className:"invalid cancel"},t):null),r)},getSendingBet:function(){var e;return this.props.engine.gameState!=="STARTING"&&(e=s.a({onClick:this.props.engine.cancelBet.bind(this.props.engine)},"cancel")),s.span(null,"Sending bet...",e)},getBetting:function(){var e=this.props.engine.nextBetAmount,n=this.props.engine.nextAutoCashout,r=" with auto cash-out at "+n/100+"x";return s.div({className:"cash-out"},s.a({className:"big-button-disable unclick"},"Betting "+t.formatSatoshis(e)+" "+o(e),r),s.div({className:"cancel"},this.getSendingBet()))},getCashOut:function(){return s.div({className:"cash-out"},s.a({className:"big-button unclick",onClick:this.cashOut},"Cash out at ",r({engine:this.props.engine})," bits"))},getContents:function(){return this.props.engine.gameState==="IN_PROGRESS"&&this.props.engine.userState==="PLAYING"?this.getCashOut():this.props.engine.nextBetAmount||this.props.engine.gameState==="STARTING"&&this.props.engine.userState==="PLAYING"?this.getBetting():this.getBetter()},toggleAutoPlay:function(){var e=this.state.auto_play;e&&this.props.engine.cancelAutoPlay(),this.setState({auto_play:!e})},render:function(){console.log(this.props.engine.gameState," -> ",this.props.engine.userState);var e=this;return this.props.engine.username?s.div({className:"grid grid-pad "},s.div({className:"controls"},s.h5({className:"information"},this.getStatusMessage()),this.getContents()),s.div({className:"game-hash"},"Hash: ",s.a({href:"/faq#fair",target:"blank"},this.props.engine.hash)),s.div({className:"auto-bet"},s.label(null,s.input({type:"checkbox",name:"autoplay",onChange:this.toggleAutoPlay,checked:this.state.auto_play,disabled:this.invalidBet()}),"auto bet"))):s.div({className:"grid grid-pad"},s.div({className:"controls"},s.div({className:"login"},s.a({className:"big-button unselect",href:"/login"},"Login to play"),s.a({href:"/register",className:"register"},"or register "))))}})});