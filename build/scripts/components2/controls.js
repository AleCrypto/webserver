define(["lib/react","lib/clib","lib/lodash","components2/countdown","components2/bet_button","components2/cashout_button"],function(e,t,n,r,i,s){var o=e.DOM;return e.createClass({displayName:"Controls",propTypes:{engine:e.PropTypes.object.isRequired},componentWillMount:function(){var e=this;e.props.engine.on("cancel_bet",function(){e.setState({auto_play:!1})})},getInitialState:function(){return{bet_size:"1",cash_out:"2.00",auto_play:!1}},invalidBet:function(){var e=this;if(e.props.engine.balanceSatoshis<100)return"Not enough bits to play";if(!/^\d+k*$/.test(e.state.bet_size))return"Bet may only contain digits, and k (to mean 1000)";var t=parseInt(e.state.bet_size.replace(/k/g,"000"));if(t<1)return"The bet should be at least 1 bit";if(t>1e5)return"The bet must be less no more than 100,000 bits";var r=e.state.cash_out;return/^\d+(\.\d{1,2})?$/.test(r)?(r=parseFloat(r),console.assert(!n.isNaN(r)),n.isNaN(t)||r<1||Math.floor(t)!==t?"The bet should be an integer greater than or equal to one":e.props.engine.balanceSatoshis<t*100?"Not enough bits":null):"Invalid auto cash out amount"},getStatusMessage:function(){if(this.props.engine.gameState==="STARTING")return r({engine:this.props.engine});if(this.props.engine.gameState==="IN_PROGRESS")return this.props.engine.userState==="PLAYING"?o.span(null,"Currently playing..."):this.props.engine.lastGameWonAmount?o.span(null,"Cashed Out @  ",o.b({className:"green"},this.props.engine.lastGameWonAmount/this.props.engine.lastBet,"x")," / Won: ",o.b({className:"green"},t.formatSatoshis(this.props.engine.lastGameWonAmount))," ",t.grammarBits(this.props.engine.lastGameWonAmount)):o.span(null,"Game in progress..");if(this.props.engine.gameState==="ENDED"){if(this.props.engine.lastBet&&this.props.engine.lastGameWonAmount){var e;return this.props.engine.lastBonus&&(e=o.span(null," (+",t.formatSatoshis(this.props.engine.lastBonus)," ",t.grammarBits(this.props.engine.lastBonus)," bonus)")),o.span(null,"Cashed Out @ ",o.b({className:"green"},this.props.engine.lastGameWonAmount/this.props.engine.lastBet,"x")," / Won: ",o.b({className:"green"},t.formatSatoshis(this.props.engine.lastGameWonAmount))," ",t.grammarBits(this.props.engine.lastGameWonAmount),e)}if(this.props.engine.lastBet){var e;return this.props.engine.lastBonus&&(e=o.span(null," (+ ",t.formatSatoshis(this.props.engine.lastBonus)," ",t.grammarBits(this.props.engine.lastBonus)," bonus)")),o.span(null,"Game crashed @ ",o.b({className:"red"},this.props.engine.lastGameCrashedAt/100,"x")," / You lost ",o.b({className:"red"},this.props.engine.lastBet/100)," ",t.grammarBits(this.props.engine.lastBet),e)}return o.span(null,"Game crashed @ ",o.b({className:"red"},this.props.engine.lastGameCrashedAt/100,"x"))}},toggleAutoPlay:function(){var e=this.state.auto_play;e&&this.props.engine.cancelAutoPlay(),this.setState({auto_play:!e})},copyHash:function(){prompt("Game "+this.props.engine.gameId+" hash:",this.props.engine.hash)},getControlInputs:function(){var e=this,t=o.div(null,o.span({className:"bet-span strong"},"Bet"),o.input({type:"text",name:"bet-size",value:e.state.bet_size,onChange:function(t){e.setState({bet_size:t.target.value})}}),o.span({className:"sticky"},"Bits")),n=o.div(null,o.div({className:"auto-cash-out-span"},"Auto Cash Out @ "),o.input({min:1.1,value:e.state.cash_out,type:"number",name:"cash_out",onChange:function(t){e.setState({cash_out:t.target.value})}}),o.span({className:"sticky"},"x"));return o.div({className:"inputs-cont grid grid-pad"},o.div({className:"col-1-1"},t),o.div({className:"col-1-1"},n))},placeBet:function(){var e=parseInt(this.state.bet_size.replace(/k/g,"000"))*100;console.assert(n.isFinite(e));var t=parseFloat(this.state.cash_out);console.assert(n.isFinite(t)),t=Math.round(t*100),console.assert(n.isFinite(t)),this.props.engine.bet(e,t,this.state.auto_play,function(e){e&&console.error("Got betting error: ",e)})},render:function(){function t(e){return(e.gameState!=="IN_PROGRESS"||e.userState!=="PLAYING")&&!(e.nextBetAmount||e.gameState==="STARTING"&&e.userState==="PLAYING")}function n(e){return e.gameState!=="IN_PROGRESS"||e.userState!=="PLAYING"||e.nextBetAmount&&(e.gameState!=="IN_PROGRESS"||e.userState!=="PLAYING")}var e=this;if(!this.props.engine.username)return o.div({className:"login-container grid grid-pad"},o.div({className:"controls"},o.div({className:"login"},o.a({className:"big-button unselect",href:"/login"},"Login to play"),o.a({href:"/register",className:"register"},"or register "))));var r;n(this.props.engine)?r=i({engine:this.props.engine,invalidBet:this.invalidBet,placeBet:this.placeBet}):r=s({engine:this.props.engine,invalidBet:this.invalidBet});var u,a,f;return t(this.props.engine)?(u="col-1-2 mobile-col-1-1",f=o.div({className:"col-1-2 mobile-col-1-1"},this.getControlInputs())):(u="col-1-1 mobile-col-1-1",f=null),a=o.div({className:u},r),o.div(null,o.div({className:"controls-container"},o.h5({className:"information"},this.getStatusMessage()),o.div({className:"controls-grid grid grid-pad"},f,a),o.div({className:"auto-bet-cont"},o.label(null,o.input({type:"checkbox",name:"autoplay",onChange:this.toggleAutoPlay,checked:this.state.auto_play,disabled:this.invalidBet()}),"auto bet"))),o.div({className:"hash-cont"},o.span({className:"hash-text"},"Hash"),o.input({className:"hash-input",type:"text",value:this.props.engine.hash,readOnly:!0}),o.div({className:"hash-copy-cont",onClick:e.copyHash},o.span({className:"hash-copy"},o.i({className:"fa fa-clipboard"})))))}})});