define(["lib/socket.io-1.2.0","lib/events","lib/lodash","lib/clib"],function(e,t,n,r){function o(){var r=this;n.extend(this,t),r.ws=e(i),r.isConnected=!1,r.username=null,r.balanceSatoshis=null,r.chat=[],r.tableHistory=[],r.joined=[],r.playerInfo=null,r.gameState=null,r.created=null,r.gameId=null,r.startTime=null,r.maxBet=1e7,r.placingBet=!1,r.cashingOut=!1,r.nextBetAmount=null,r.nextAutoCashout=0,r.ws.on("err",function(e){console.error("Server sent us the error: ",e)}),r.ws.on("game_started",function(e){r.joined=[],r.gameState="IN_PROGRESS",r.startTime=Date.now(),r.lastGameTick=r.startTime,r.placingBet=!1,r.nextBetAmount=null,r.nextAutoCashout=null,Object.keys(e).forEach(function(t){r.username===t&&(r.balanceSatoshis-=e[t]),r.playerInfo[t]={bet:e[t]}}),r.trigger("game_started",r.playerInfo)}),r.ws.on("game_tick",function(e){r.lastGameTick=Date.now()}),r.ws.on("error",function(e){console.log("on error: ",e),r.trigger("error",e)}),r.ws.on("game_crash",function(e){for(var t in e.bonuses)console.assert(r.playerInfo[t]),r.playerInfo[t].bonus=e.bonuses[t],r.username===t&&(r.balanceSatoshis+=e.bonuses[t]);var n={created:r.created,ended:!0,game_crash:e.game_crash,game_id:r.gameId,hash:r.hash,player_info:r.playerInfo,seed:e.seed};r.tableHistory.length>=40&&r.tableHistory.pop(),r.tableHistory.unshift(n),r.gameState="ENDED",r.cashingOut=!1,r.trigger("game_crash",e)}),r.ws.on("game_starting",function(e){r.playerInfo={},r.joined=[],r.gameState="STARTING",r.gameId=e.game_id,r.hash=e.hash,r.startTime=new Date(Date.now()+e.time_till_start),r.nextBetAmount&&r.doBet(r.nextBetAmount,r.nextAutoCashout,function(e){e&&console.log("Response from placing a bet: ",e)}),r.trigger("game_starting",e)}),r.ws.on("player_bet",function(e){r.joined.splice(e.index,0,e.username),r.trigger("player_bet",e)}),r.ws.on("cashed_out",function(e){if(!r.playerInfo[e.username])return console.warn("Username not found in playerInfo at cashed_out: ",e.username);r.playerInfo[e.username].stopped_at=e.stopped_at,r.username===e.username&&(r.cashingOut=!1,r.balanceSatoshis+=r.playerInfo[e.username].bet*e.stopped_at/100),r.trigger("cashed_out",e)}),r.ws.on("msg",function(e){r.chat.length>500&&r.chat.splice(0,400),r.chat.push(e),r.trigger("msg",e)}),r.ws.on("update",function(){alert("Please refresh your browser! We just pushed a new update to the server!")}),r.ws.on("connect",function(){u(function(e,t){if(e&&e!=401){console.error("request ott error:",e),confirm("An error, click to reload the page: "+e)&&location.reload();return}r.ws.emit("join",{ott:t},function(e,t){if(e){console.error("Error when joining the game...",e);return}r.balanceSatoshis=t.balance_satoshis,r.chat=t.chat,r.username=t.username,r.isConnected=!0,r.gameState=t.state,r.playerInfo=t.player_info,r.gameId=t.game_id,r.hash=t.hash,r.created=t.created,r.startTime=new Date(Date.now()-t.elapsed),r.joined=t.joined,r.tableHistory=t.table_history,r.gameState=="IN_PROGRESS"&&(r.lastGameTick=Date.now()),r.trigger("connected")})})}),r.ws.on("disconnect",function(e){r.isConnected=!1,console.log("Client disconnected |",e,"|",typeof e),r.trigger("disconnected")})}function u(e){try{var t=new XMLHttpRequest;if(!t)throw new Error("Your browser doesn't support xhr");t.open("POST","/ott",!0),t.setRequestHeader("Accept","text/plain"),t.send()}catch(n){console.error(n),alert("Requesting token error: "+n),location.reload()}t.onload=function(){if(t.status==200){var n=t.responseText;e(null,n)}else t.status==401?e(t.status):e(t.responseText)}}function a(e){console.assert(typeof e=="number"&&e>=0);var t=6e-5;return Math.floor(100*Math.pow(Math.E,t*e))/100}var i=window.document.location.host==="www.moneypot.com"?"https://game.moneypot.com":window.document.location.host.replace(/:3841$/,":3842"),s=300;return o.prototype.say=function(e){console.assert(e.length>1&&e.length<500),this.ws.emit("say",e)},o.prototype.nextGameIn=function(){return console.assert(this.gameState==="STARTING"),Math.max(this.startTime-Date.now(),0)},o.prototype.bet=function(e,t,n){console.assert(typeof e=="number"),console.assert(r.isInteger(e)),console.assert(!t||typeof t=="number"&&t>=100);if(!r.isInteger(e)||e%100!=0)return console.error("The bet amount should be integer and divisible by 100");this.nextBetAmount=e,this.nextAutoCashout=t;if(this.gameState==="STARTING")return this.doBet(e,t,n);n(null,"WILL_JOIN_NEXT"),this.trigger("bet_queued")},o.prototype.doBet=function(e,t,n){var r=this;r.placingBet=!0,this.ws.emit("place_bet",e,t,function(e){if(e){console.warn("place_bet error: ",e),e!=="GAME_IN_PROGRESS"&&e!=="ALREADY_PLACED_BET"&&alert("There was an error, please reload the window: "+e),n&&n(e);return}r.trigger("bet_placed"),n&&n(null)}),r.trigger("placing_bet")},o.prototype.cancelBet=function(){if(!this.nextBetAmount)return console.error("Can not cancel next bet, wasn't going to make it...");this.nextBetAmount=null,this.trigger("cancel_bet")},o.prototype.cashOut=function(e){var t=this;this.cashingOut=!0,this.ws.emit("cash_out",function(t){t&&console.warn("Cashing out error: ",t),e(t)}),this.trigger("cashing_out")},o.prototype.getGamePayout=function(){if(this.gameState!=="IN_PROGRESS")return null;if(Date.now()-this.lastGameTick<s)var e=Date.now()-this.startTime;else var e=this.lastGameTick-this.startTime+s;var t=a(e);return console.assert(isFinite(t)),t},o.prototype.calcGamePayout=function(e){return a(e)},o.prototype.isBetting=function(){if(!this.username)return!1;if(this.nextBetAmount)return!0;for(var e=0;e<this.joined.length;++e)if(this.joined[e]==this.username)return!0;return!1},o.prototype.currentPlay=function(){return this.username?this.playerInfo[this.username]:null},o.prototype.getElapsedTime=function(){return this.gameState==="IN_PROGRESS"?Date.now()-this.startTime:null},o});